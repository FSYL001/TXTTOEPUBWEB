<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TXT → EPUB 转换器</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,"Noto Sans",sans-serif;margin:18px;background:#f7fafc;color:#111}
    .container{max-width:980px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h1{font-size:20px;margin:6px 0 12px}
    label{display:block;margin-top:10px;font-weight:600}
    input[type=text],select,textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
    textarea{height:220px;font-family:monospace;white-space:pre-wrap;overflow:auto}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .small{font-size:13px;color:#666}
    button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
    .muted{color:#666;font-size:13px}
    .options{display:flex;gap:12px;flex-wrap:wrap}
    .option{background:#f3f4f6;padding:8px;border-radius:8px}
    .preview-wrap{margin-top:12px}
    .cover-preview{max-width:240px;border:1px solid #e5e7eb;padding:6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>TXT → EPUB 网页版</h1>
    <p class="muted">功能：支持多编码（UTF-8 / GBK / ANSI/Windows-1252 / ISO-8859-1），预览文本，章节分割策略，导入图片封面或用文字（书名+作者）生成封面，导出文件名为 <code>书名-作者.epub</code>。</p>

    <label>选择 TXT 文件（可多选，但我们只读取第一个）</label>
    <input id="fileTxt" type="file" accept=".txt,text/plain" />

    <label>文件编码</label>
    <select id="encoding">
      <option value="utf-8">UTF-8</option>
      <option value="gbk">GBK</option>
      <option value="windows-1252">Windows-1252 (常称 ANSI)</option>
      <option value="iso-8859-1">ISO-8859-1</option>
    </select>

    <div class="row">
      <div class="col">
        <label>书名</label>
        <input id="title" type="text" placeholder="示例：我的小说" />
      </div>
      <div class="col">
        <label>作者</label>
        <input id="author" type="text" placeholder="示例：风神翼龙" />
      </div>
    </div>

    <label>选择章节分割策略</label>
    <div class="options">
      <label class="option"><input type="radio" name="split" value="blank" checked /> 按空行分割（默认）</label>
      <label class="option"><input type="radio" name="split" value="heading" /> 按行首标题（例如以「第」或 # 开头）</label>
      <label class="option"><input type="radio" name="split" value="lines" /> 每 N 行分为一章：<input id="linesCount" type="number" value="200" min="1" style="width:100px;margin-left:6px" /></label>
      <label class="option"><input type="radio" name="split" value="chars" /> 每 N 字分章：<input id="charsCount" type="number" value="2000" min="100" style="width:120px;margin-left:6px" /></label>
    </div>

    <label>封面（可选）</label>
    <div class="row">
      <div style="flex:0 0 260px">
        <input id="coverFile" type="file" accept="image/*" />
        <div style="margin-top:8px">
          <label><input id="useTextCover" type="checkbox" /> 使用 书名 + 作者 生成文字封面（若选择图片，会优先采用图片）</label>
        </div>
        <div style="margin-top:8px">
          <img id="coverPreview" class="cover-preview" alt="封面预览" />
        </div>
      </div>
      <div style="flex:1">
        <label>文本预览（可编辑）</label>
        <textarea id="preview"></textarea>
      </div>
    </div>

    <label>更多设置</label>
    <div class="options">
      <label class="option"><input id="includeToc" type="checkbox" checked /> 包含目录（toc）</label>
      <label class="option"><input id="utf8meta" type="checkbox" checked /> 使用 UTF-8 元数据（推荐）</label>
    </div>

    <button id="btnConvert">生成 EPUB 并下载</button>

    <div style="margin-top:10px" class="small">说明：生成在浏览器端完成，不会上传服务器。若 TXT 出现乱码，请尝试切换编码为 GBK 或 Windows-1252。</div>
  </div>

  <!-- 依赖库（通过 CDN 加载） -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/encoding-japanese@1.0.30/encoding.min.js"></script>

  <script>
    // 辅助：清理文件名中的非法字符
    function sanitizeFileName(name){
      return (name||'book').replace(/[\\/:*?"<>|\u0000-\u001F]/g, '_').trim();
    }

    // 读取文件并按选择编码转换为字符串
    async function readTxtFile(file, encoding){
      const ab = await file.arrayBuffer();
      // 使用 encoding-japanese 做编码转换以兼容 GBK/ANSI
      if(encoding === 'utf-8'){
        return new TextDecoder('utf-8').decode(ab);
      }
      try{
        // encoding.js expects a Uint8Array
        const u8 = new Uint8Array(ab);
        const arr = Encoding.convert(u8, {from: encoding, to:'UNICODE', type:'array'});
        return Encoding.codeToString(arr);
      }catch(e){
        // 兜底：用 TextDecoder 尝试
        try{ return new TextDecoder(encoding).decode(ab); }catch(e2){ return new TextDecoder('utf-8').decode(ab); }
      }
    }

    // 章节切分函数
    function splitIntoChapters(text, strategy){
      const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
      const chapters = [];
      if(strategy === 'blank'){
        let cur = [];
        for(const ln of lines){
          if(ln.trim() === ''){
            if(cur.length){ chapters.push(cur.join('\n').trim()); cur = []; }
          }else cur.push(ln);
        }
        if(cur.length) chapters.push(cur.join('\n').trim());
      }else if(strategy === 'heading'){
        let cur = [];
        for(const ln of lines){
          if(/^\s*(第[^\s]{1,8}|#|Chapter\b|CHAPTER\b|\d+\.)/.test(ln)){
            if(cur.length) { chapters.push(cur.join('\n').trim()); cur = []; }
          }
          cur.push(ln);
        }
        if(cur.length) chapters.push(cur.join('\n').trim());
      }else if(strategy === 'lines'){
        const n = parseInt(document.getElementById('linesCount').value) || 200;
        for(let i=0;i<lines.length;i+=n){ chapters.push(lines.slice(i,i+n).join('\n').trim()); }
      }else if(strategy === 'chars'){
        const n = parseInt(document.getElementById('charsCount').value) || 2000;
        let i=0;
        let s = text;
        while(i<s.length){ chapters.push(s.slice(i,i+n)); i+=n; }
      }
      // 过滤空章节
      return chapters.filter(c=>c && c.length>0);
    }

    // 生成 XHTML 内容（简单模板）
    function makeXHTML(title, bodyHtml){
      return `<?xml version="1.0" encoding="utf-8"?>\n<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml">\n<head><meta charset="utf-8"/><title>${escapeXml(title)}</title></head>\n<body>\n${bodyHtml}\n</body>\n</html>`;
    }

    function escapeXml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // 生成 EPUB
    async function generateEpub({title, author, chapters, coverBlob, useTextCover, includeToc, utf8meta}){
      const zip = new JSZip();
      // 1) mimetype（必须且无压缩）
      zip.file('mimetype','application/epub+zip',{compression:'STORE'});
      // 2) META-INF/container.xml
      zip.folder('META-INF').file('container.xml', `<?xml version="1.0"?>\n<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">\n  <rootfiles>\n    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>\n  </rootfiles>\n</container>`);

      // 3) OEBPS
      const oebps = zip.folder('OEBPS');
      // images
      if(coverBlob){
        const imgData = await blobToUint8Array(coverBlob);
        oebps.folder('images').file('cover.jpg', imgData);
      }

      // chapters
      const itemrefs = [];
      const manifestItems = [];
      for(let i=0;i<chapters.length;i++){
        const id = `chap${i+1}`;
        const filename = `chapter_${i+1}.xhtml`;
        const body = '<h1>'+escapeXml((chapters[i].split('\n',1)[0]||('第'+(i+1)+'章')).trim())+'</h1>\n' + '<div>' + escapeXml(chapters[i]).replace(/\n/g,'<br/>') + '</div>';
        oebps.file(filename, makeXHTML((title||'')+' - '+id, body));
        manifestItems.push(`<item id="${id}" href="${filename}" media-type="application/xhtml+xml"/>`);
        itemrefs.push(`<itemref idref="${id}"/>`);
      }

      // cover page if using text cover
      if(!coverBlob && useTextCover){
        const coverHtml = `<div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;font-family:serif;"><h1>${escapeXml(title||'')}</h1><h2>${escapeXml(author||'')}</h2></div>`;
        oebps.file('cover.xhtml', makeXHTML('Cover', coverHtml));
        manifestItems.push(`<item id="cover" href="cover.xhtml" media-type="application/xhtml+xml" properties="cover-image"/>`);
        itemrefs.unshift(`<itemref idref="cover"/>`);
      }else if(coverBlob){
        // include a small cover.xhtml that references the image
        const coverHtml = `<div><img src="images/cover.jpg" alt="cover" style="max-width:100%;height:auto;display:block;margin:0 auto;"/></div>`;
        oebps.file('cover.xhtml', makeXHTML('Cover', coverHtml));
        manifestItems.push(`<item id="cover" href="cover.xhtml" media-type="application/xhtml+xml" properties="cover-image"/>`);
        manifestItems.push(`<item id="cover-image" href="images/cover.jpg" media-type="image/jpeg"/>`);
        itemrefs.unshift(`<itemref idref="cover"/>`);
      }

      // toc.ncx (可选)
      if(includeToc){
        let navPoints = '';
        for(let i=0;i<chapters.length;i++){
          navPoints += `<navPoint id="navPoint-${i+1}" playOrder="${i+1}">\n  <navLabel><text>第${i+1}章</text></navLabel>\n  <content src="chapter_${i+1}.xhtml"/>\n</navPoint>\n`;
        }
        const ncx = `<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE ncx PUBLIC "-//NISO//DTD ncx 2005-1//EN" "http://www.daisy.org/z3986/2005/ncx-2005-1.dtd">\n<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">\n  <head>\n    <meta name="dtb:uid" content="urn:uuid:${generateUUID()}"/>\n  </head>\n  <docTitle><text>${escapeXml(title||'')}</text></docTitle>\n  <navMap>\n${navPoints}\n  </navMap>\n</ncx>`;
        oebps.file('toc.ncx', ncx);
        manifestItems.push('<item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>');
      }

      // content.opf
      const uuid = generateUUID();
      const now = new Date().toISOString();
      const metadata = `<?xml version="1.0" encoding="${utf8meta? 'UTF-8' : 'utf-8'}"?>\n<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="uid" version="2.0">\n  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">\n    <dc:title>${escapeXml(title||'')}</dc:title>\n    <dc:creator>${escapeXml(author||'')}</dc:creator>\n    <dc:identifier id="uid">urn:uuid:${uuid}</dc:identifier>\n    <dc:language>zh-CN</dc:language>\n    <dc:date>${now}</dc:date>\n  </metadata>\n  <manifest>\n    ${manifestItems.join('\n    ')}\n  </manifest>\n  <spine toc="ncx">\n    ${itemrefs.join('\n    ')}\n  </spine>\n</package>`;
      oebps.file('content.opf', metadata);

      // 生成 zip blob
      const blob = await zip.generateAsync({type:'blob',mimeType:'application/epub+zip'});
      return blob;
    }

    function generateUUID(){
      // 简单 UUID
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});
    }

    function blobToUint8Array(blob){
      return new Promise((res,rej)=>{const reader=new FileReader();reader.onload=()=>res(new Uint8Array(reader.result));reader.onerror=rej;reader.readAsArrayBuffer(blob);});
    }

    // 事件绑定
    document.getElementById('fileTxt').addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const enc = document.getElementById('encoding').value;
      try{
        const text = await readTxtFile(f, enc);
        document.getElementById('preview').value = text;
      }catch(err){
        alert('读取文件失败：'+err);
      }
    });

    document.getElementById('coverFile').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      const img = document.getElementById('coverPreview');
      if(!f){ img.src = ''; return; }
      const url = URL.createObjectURL(f);
      img.src = url;
      img.onload = ()=>URL.revokeObjectURL(url);
    });

    document.getElementById('btnConvert').addEventListener('click', async ()=>{
      const title = document.getElementById('title').value || 'book';
      const author = document.getElementById('author').value || 'author';
      const previewText = document.getElementById('preview').value;
      if(!previewText || previewText.trim().length===0){ alert('请先加载或粘贴 TXT 文本到预览框'); return; }
      // determine split strategy
      const strategy = document.querySelector('input[name="split"]:checked').value;
      const chapters = splitIntoChapters(previewText, strategy);
      if(chapters.length===0){ alert('没有分出任何章节，请检查分割策略或文本内容'); return; }

      // cover
      const coverFile = document.getElementById('coverFile').files[0];
      const useTextCover = document.getElementById('useTextCover').checked;
      let coverBlob = null;
      if(coverFile){
        // convert to jpeg if possible by drawing to canvas (to normalize format)
        coverBlob = coverFile;
      }

      // include toc
      const includeToc = document.getElementById('includeToc').checked;
      const utf8meta = document.getElementById('utf8meta').checked;

      document.getElementById('btnConvert').disabled = true;
      document.getElementById('btnConvert').textContent = '生成中...';
      try{
        const epubBlob = await generateEpub({title, author, chapters, coverBlob, useTextCover, includeToc, utf8meta});
        const filename = sanitizeFileName(title) + '-' + sanitizeFileName(author) + '.epub';
        saveAs(epubBlob, filename);
      }catch(err){
        alert('生成 EPUB 失败：'+err);
        console.error(err);
      }finally{
        document.getElementById('btnConvert').disabled = false;
        document.getElementById('btnConvert').textContent = '生成 EPUB 并下载';
      }
    });

    // 若用户切换编码后希望重新读文件
    document.getElementById('encoding').addEventListener('change', async ()=>{
      const f = document.getElementById('fileTxt').files[0];
      if(!f) return;
      const enc = document.getElementById('encoding').value;
      try{ const text = await readTxtFile(f, enc); document.getElementById('preview').value = text; }catch(e){}
    });
  </script>
</body>
</html>